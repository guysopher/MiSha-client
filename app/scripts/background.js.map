{"version":3,"sources":["../scripts.babel/background.js"],"names":[],"mappings":"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","file":"background.js","sourcesContent":["'use strict';\n//\n//chrome.runtime\n//  .onInstalled.addListener(details => {\n//  console.log('previousVersion', details.previousVersion);\n//});\n\n//var api = 'http://misha-api.herokuapp.com';;\nvar api = 'http://localhost:1337';\n\nvar me = undefined;\n\nvar seenInterval = 12 * 1000;\nvar awayDuration = 2 * 60 * 1000;\n\nvar notifs = [];\nchrome.storage.local.get('notifications', function (res) {\n  if (res.notifications) {\n    notifs = res.notifications;\n    console.log('Get current messages: ', notifs);\n  }\n});\n\nfunction isAvailable(user) {\n  if (!user || !user.last_seen || !user.hasOwnProperty('last_seen')) return false;\n  if (!user.status) return false;\n  if (user.busy && user.busy != \"false\") return false;\n  var now = (new Date()).getTime();\n  var lastSeen;\n  lastSeen = (new Date(Number(user.last_seen))).getTime();\n  console.log(\"Last seen \" + (now - lastSeen) / 60 / 1000 + \" minutes ago\");\n  return ((now - lastSeen) < (2 * 60 * 1000))\n}\n\nvar calculateRate = function (ratesByDays, today, tomorrow) {\n  //returns a number between 0 and 1\n  var total = 0;\n  for (var i = 0; i < 7; i++) {\n    if (i != today && i != tomorrow) {\n      total += ratesByDays[i];\n    }\n  }\n  total = Math.min(1,\n    (total / 60 / 60 / 8 / 5) //8 hours a day in the last 5 days is the max\n  );\n  return total;\n}\n\nvar seenLoop = function () {\n\n  var today = (new Date()).getDay();\n  var tomorrow = ((new Date()).getDay() + 1) % 7;\n\n  //clear next day data\n  me.rateByDay[tomorrow] = 0;\n\n  me.rate = calculateRate(me.rateByDay, today, tomorrow);\n\n  chrome.browserAction.setBadgeText({text: me.status.replace('available', 'free')});\n\n  //if the user status is not busy - make sure he's not away\n  if (me.busy && me.busy != \"false\") {\n\n  } else {\n\n    if (typeof(me.reasons) == 'undefined') me.reasons = {};\n\n    //if not charging - set as away\n    navigator.getBattery().then(function (res) {\n      console.log('Got Battery: ', res);\n      if (!res.charging) {\n        console.log(\"You're running on battery power\");\n        me.reasons['Running on battery power'] = true;\n      } else {\n        console.log(\"You're NOT running on battery power\");\n        me.reasons['Running on battery power'] = false;\n      }\n    });\n\n    //if not if tel-aviv port - set as away\n    navigator.geolocation.getCurrentPosition(function (res) {\n\n      console.log('Got Location: ', res);\n      var lat = res.coords.latitude;\n      var lon = res.coords.longitude;\n\n      if (lat < 32.102660 && lat > 32.096141 && lon > 34.772296 && lon < 34.777674) {\n        //user is in the port\n        console.log(\"You're at Tel Aviv port\");\n        me.reasons['Not at Tel-Aviv Port'] = false;\n      } else {\n        console.log(\"You're NOT at Tel Aviv port\");\n        me.reasons['Not at Tel-Aviv Port'] = true;\n      }\n\n    });\n\n    //if chrome is idle for 2 minutes - set status as away\n    chrome.idle.queryState(2 * 60, function (res) {\n      console.log('Got Idle: ', res);\n      if (res != 'active') {\n        console.log(\"Chrome is idle\");\n        me.reasons['Chrome is idle'] = true;\n      } else {\n        console.log(\"Chrome is NOT idle\");\n        me.reasons['Chrome is idle'] = false;\n      }\n    });\n\n    if (isAvailable(me)) {\n      console.log(\"Computer is NOT sleeping\");\n      me.reasons['Computer is sleeping'] = false;\n    } else {\n      console.log(\"Computer is sleeping\");\n      me.reasons['Computer is sleeping'] = true;\n    }\n\n    //todo (oded) if not free in calendar - set as away\n\n    var r;\n    var reasons = [];\n    for (r in me.reasons) {\n      if (me.reasons.hasOwnProperty(r) && (me.reasons[r] && me.reasons[r] != \"false\")) {\n        reasons.push(r);\n      }\n    }\n\n    me.reason = \"\";\n    if (reasons.length > 0) {\n      me.status = 'away';\n      me.reason = reasons.join(' & ');\n\n    }\n\n    //add seenInterval seconds to availability rate\n    me.rateByDay[today] += (seenInterval / 1000);\n\n    $.post(api + '/user/seen?user_id=' + me.id, {user: me}, function (res) {\n      console.log(\"got response\", res);\n      console.count(\"got response\");\n\n      if (res.notify) {\n        //$.delete(api + '/pending/' + res.pending, function(res) {\n        //  console.log('Deleted: ', res);\n        //});\n\n        notifs.push(res);\n        chrome.storage.local.set({notifications: notifs}, function (err, localNotifs) {\n          console.log('Set current messages: ', localNotifs);\n        });\n\n        chrome.notifications.create('temp', {\n          type: \"basic\",\n          iconUrl: \"images/icon-128.png\",\n          title: res.user,\n          message: res.message,\n          expandedMessage: \" Expanded message\"\n\n        }, function (data) {\n          console.log('Notification callback', data);\n        })\n      }\n    });\n  }\n}\n\nvar initInterval = function () {\n\n  var defaultRate = 60 * 60 * 4; //four hours\n\n  if (!me.rate) {\n    me.rateByDay = [defaultRate, defaultRate, defaultRate, defaultRate, defaultRate, defaultRate, defaultRate];\n    var today = (new Date()).getDay();\n    var tomorrow = ((new Date()).getDay() + 1) % 7;\n    me.rate = calculateRate(me.rateByDay, today, tomorrow);\n  }\n  setInterval(seenLoop, seenInterval);\n}\n\nvar getUserIdFromEmail = function (email) {\n  $.get(api + '/user?email=' + email, function (res) {\n    me = res[0];\n    console.log('Got User:', me);\n    initInterval();\n  });\n}\n\nvar refreshUser = function (user) {\n  return;\n  $.get(api + '/user/?id=' + user.id, function (res) {\n    me = res;\n    console.log('Got User:', me);\n  });\n}\n\nchrome.identity.getProfileUserInfo(function (res) {\n  if (res.email && res.email.indexOf('@wix.com') > 0) {\n    getUserIdFromEmail(res.email);\n  //} else {\n  //  chrome.storage.local.get('me', function(res) {\n  //    if (res.me) {\n  //      refreshUser();\n  //      initInterval(res.me);\n  //    } else {\n  //      chrome.identity.getAuthToken({ 'interactive': true }, function (token) {\n  //        //load Google's javascript client libraries\n  //\n  //        var x = new XMLHttpRequest();\n  //        x.open('GET', 'https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=' + token);\n  //        x.onload = function () {\n  //          var parsed_response = JSON.parse(x.response);\n  //          getUserIdFromEmail(parsed_response.email);\n  //        };\n  //        x.send();\n  //      });\n  //    }\n  //  });\n  }\n});\n"]}