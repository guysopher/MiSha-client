{"version":3,"sources":["../scripts.babel/background.js"],"names":[],"mappings":"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","file":"background.js","sourcesContent":["'use strict';\n//\n//chrome.runtime\n//  .onInstalled.addListener(details => {\n//  console.log('previousVersion', details.previousVersion);\n//});\n\n\nvar api = 'http:localhost:1337'; //http://misha-api.herokuapp.com';\n\nvar me = undefined;\n\nvar notifs = [];\nchrome.storage.local.get('notifications', function (res) {\n  if (res.notifications) {\n    notifs = res.notifications;\n    console.log('Get current messages: ', notifs);\n  }\n});\n\nfunction isAvailable(user) {\n  if (!user || !user.last_seen || !user.hasOwnProperty('last_seen')) return false;\n  if (!user.status || user.status != 'available') return false;\n  if (user.busy) return false;\n  var now = (new Date()).getTime();\n  var lastSeen;\n  lastSeen = (new Date(Number(user.last_seen))).getTime();\n  return ((now - lastSeen) < (2 * 60 * 1000))\n}\n\n\nvar initInterval = function (me) {\n  setInterval(function(){\n\n    //if the user status is not busy - make sure he's not away\n    if (me.busy) {\n      \n    }else{\n\n      if (typeof(me.reasons) == 'undefined') me.reasons = {};\n\n      //if not charging - set as away\n      navigator.getBattery().then(function (res) {\n        console.log('Got Battery: ', res);\n        if (!res.charging) {\n          console.log(\"You're running on battery power\");\n          me.reasons['Running on battery power'] = true;\n        } else {\n          console.log(\"You're NOT running on battery power\");\n          me.reasons['Running on battery power'] = false;\n        }\n      });\n\n      //if not if tel-aviv port - set as away\n      navigator.geolocation.getCurrentPosition(function(res) {\n\n        console.log('Got Location: ', res);\n        var lat = res.coords.latitude;\n        var lon = res.coords.longitude;\n\n        if (lat < 32.102660 && lat > 32.096141 && lon > 34.772296 && lon < 34.777674) {\n            //user is in the port\n          console.log(\"You're at Tel Aviv port\");\n          me.reasons['Not at Tel-Aviv Port'] = false;\n        } else {\n          console.log(\"You're NOT at Tel Aviv port\");\n          me.reasons['Not at Tel-Aviv Port'] = true;\n        }\n\n      });\n\n      //if chrome is idle for 2 minutes - set status as away\n      chrome.idle.queryState(2 * 60, function(res) {\n        console.log('Got Idle: ', res);\n        if (res != 'active') {\n          console.log(\"Chrome is idle\");\n          me.reasons['Chrome is idle'] = true;\n        } else {\n          console.log(\"Chrome is NOT idle\");\n          me.reasons['Chrome is idle'] = false;\n        }\n      });\n\n      if (isAvailable(me)) {\n        console.log(\"Computer is NOT sleeping\");\n        me.reasons['Computer is sleeping'] = false;\n      } else {\n        console.log(\"Computer is sleeping\");\n        me.reasons['Computer is sleeping'] = true;\n      }\n\n      //todo (oded) if not free in calendar - set as away\n\n      var r;\n      var reasons = [];\n      for (r in me.reasons) {\n        if (me.reasons.hasOwnProperty(r) && (me.reasons[r] && me.reasons[r] != \"false\")) {\n          reasons.push(r);\n        }\n      }\n\n      me.reason = \"\";\n      if (reasons.length > 0) {\n        me.status = 'away';\n        me.reason = reasons.join(' & ');\n\n      }\n    }\n\n    refreshUser(me);\n\n    $.post(api + '/user/seen?user_id=' + me.id, {user: me}, function(res) {\n      console.log(\"got response\", res);\n      console.count(\"got response\");\n\n      if (res.notify) {\n        //$.delete(api + '/pending/' + res.pending, function(res) {\n        //  console.log('Deleted: ', res);\n        //});\n\n        notifs.push(res);\n        chrome.storage.local.set({notifications: notifs}, function (err, localNotifs) {\n          console.log('Set current messages: ', localNotifs);\n        });\n\n        chrome.browserAction.setBadgeText({text: '1'});\n        chrome.notifications.create('temp', {\n          type: \"basic\",\n          iconUrl: \"images/icon-128.png\",\n          title: res.user,\n          message: res.message,\n          expandedMessage: \" Expanded message\"\n\n        }, function(data) {\n          console.log('Notification callback', data);\n        })\n      }\n    });\n  }, 12000);\n}\n\nvar getUserIdFromEmail = function(email) {\n  $.get(api + '/user?email=' + email, function (res) {\n    me = res[0];\n    console.log('Got User:', me);\n    chrome.storage.local.set({ me: me });\n    initInterval(me);\n  });\n}\n\nvar refreshUser = function(me) {\n  $.get(api + '/user/?id=' + me.id, function (res) {\n    me = res;\n    console.log('Got User:', me);\n    chrome.storage.local.set({ me: me });\n  });\n}\n\n\nchrome.identity.getProfileUserInfo(function(res) {\n  if (res.email && res.email.indexOf('@wix.com') > 0) {\n    getUserIdFromEmail(res.email);\n  } else {\n    chrome.storage.local.get('me', function(res) {\n      if (res.me) {\n        initInterval(res.me);\n      } else {\n        chrome.identity.getAuthToken({ 'interactive': true }, function (token) {\n          //load Google's javascript client libraries\n\n          var x = new XMLHttpRequest();\n          x.open('GET', 'https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=' + token);\n          x.onload = function () {\n            var parsed_response = JSON.parse(x.response);\n            getUserIdFromEmail(parsed_response.email);\n          };\n          x.send();\n        });\n      }\n    });\n  }\n});\n"]}